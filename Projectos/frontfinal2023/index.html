<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./axios/axios.min.js"></script>
</head>

<body>
    <style>
        table {
            width: 100%;
            border: 1px solid #000;
        }

        th,
        td {
            width: 25%;
            text-align: center;
            /*         vertical-align: top; */
            border: 1px solid #000;
        }
    </style>
    <h1>Examen Final</h1>
    <h3>Pedidos Por Localidad</h3>

    <select class="custom-select" id="select1">

    </select>
    <button type="button" onclick="cargarPedidos()">
        Buscar
    </button>


    <br><br><br>
    <div id="tabla-container">
        <!-- Aquí se insertará la tabla generada -->
    </div>



    <script>
        cargarCiudades();

        function cargarCiudades() {
            let selectciudades = document.getElementById("select1");
            const apiUrl = `http://localhost:3000/api/localidad`;

            axios.get(`${apiUrl}`)
                .then(function (response) {
                    // La respuesta de la API se encuentra en 'response.data'
                    const ciudades = response.data;
                    console.log(response.data);

                    let opciondisabled = document.createElement("option");

                    opciondisabled.disabled = true;
                    opciondisabled.value = 0;
                    opciondisabled.textContent = "Selecione una Localidad";
                    opciondisabled.selected = true;

                    selectciudades.appendChild(opciondisabled);

                    for (let index = 0; index < ciudades.length; index++) {
                        const option = document.createElement("option");
                        option.value = ciudades[index].idLocalidad;
                        option.textContent = ciudades[index].nombreLocalidad.trim();

                        selectciudades.appendChild(option);
                    }


                })
                .catch(function (error) {
                    // Manejo de errores si la solicitud no tiene éxito
                    console.error('Error al obtener el post:', error);
                });




        }


        function cargarPedidos() {
            let codigopostal = document.getElementById("select1").value;
            const apiUrl = `http://localhost:3000/api/pedido/busqueda/${codigopostal}`;

            axios.get(`${apiUrl}`)
                .then(function (response) {
                    // La respuesta de la API se encuentra en 'response.data'
                    let pedidos = response.data;
                    console.log(response.data);

                    for (let index = 0; index < pedidos.length; index++) {
                        //const element = array[index];
                        console.log(pedidos[index]);

                    }


                    // Obtener el contenedor de la tabla
                    const tablaContainer = document.getElementById('tabla-container');
                    tablaContainer.innerHTML = "";
                    // Crear un elemento de tabla
                    const tabla = document.createElement('table');


                    // Crear una fila de encabezado
                    const encabezado = document.createElement('tr');

                    // Crear celdas de encabezado
                    const encabezado1 = document.createElement('th');
                    encabezado1.textContent = 'IdPerdido';
                    const encabezado2 = document.createElement('th');
                    encabezado2.textContent = 'Nombre';
                    const encabezado3 = document.createElement('th');
                    encabezado3.textContent = 'Apellido';
                    const encabezado4 = document.createElement('th');
                    encabezado4.textContent = 'Nombre Localidad';
                    const encabezado5 = document.createElement('th');
                    encabezado5.textContent = 'Total Pedido';
                    const encabezado6 = document.createElement('th');
                    encabezado6.textContent = 'Estado';
                    const encabezado7 = document.createElement('th');
                    encabezado7.textContent = 'Acciones';
                    const encabezado8 = document.createElement('th');
                    encabezado8.textContent = 'Telefono';

                    // Agregar celdas de encabezado a la fila de encabezado
                    encabezado.appendChild(encabezado1);
                    encabezado.appendChild(encabezado2);
                    encabezado.appendChild(encabezado3);
                    encabezado.appendChild(encabezado8);
                    encabezado.appendChild(encabezado4);
                    encabezado.appendChild(encabezado5);
                    encabezado.appendChild(encabezado6);
                    encabezado.appendChild(encabezado7);

                    // Agregar la fila de encabezado a la tabla
                    tabla.appendChild(encabezado);

                    // Crear filas de datos

                    response.data.forEach(function (item) {
                        console.log(item);
                        //item.id
                        const fila = document.createElement('tr');

                        // Crear celdas de datos
                        const dato1 = document.createElement('td');
                        dato1.textContent = item.idPedido;
                        const dato2 = document.createElement('td');
                        dato2.textContent = item.nombre;
                        const dato3 = document.createElement('td');
                        dato3.textContent = item.apellido;
                        const dato4 = document.createElement('td');
                        dato4.textContent = item.telefono;
                        const dato5 = document.createElement('td');
                        dato5.textContent = item.nombreLocalidad;
                        const dato6 = document.createElement('td');
                        dato6.textContent = item.totalpedido;
                        const dato7 = document.createElement('td');
                        dato7.textContent = item.nombreestado;



                        /*   "idPedido": 3,
               "idCliente": 2,
               "idLocalidad": 3,
               "idEstado": 1,
               "totalpedido": "258",
               "nombre": "Matias",
               "apellido": "Lisandron",
               "telefono": "352444888",
               "nombreLocalidad": "Cordoba",
               "nombreestado": "Pendiente" */
                        const dato8 = document.createElement('td');
                        // Boton eliminar
                        let eliminarButton = document.createElement("button");
                        eliminarButton.textContent = "Actualizar Estado";
                        eliminarButton.classList = "btn danger";
                        eliminarButton.type = "button";
                        eliminarButton.addEventListener("click", function () {
                            actualizarEstado(item.idPedido, item.idEstado);//le paso al ID a la funcion eliminar
                        });

                        dato8.appendChild(eliminarButton);

                        // Agregar celdas de datos a la fila
                        fila.appendChild(dato1);
                        fila.appendChild(dato2);
                        fila.appendChild(dato3);
                        fila.appendChild(dato4);
                        fila.appendChild(dato5);
                        fila.appendChild(dato6);
                        fila.appendChild(dato7);
                        fila.appendChild(dato8);

                        // Agregar la fila a la tabla
                        tabla.appendChild(fila);
                    });

                    // Agregar la tabla al contenedor
                    tablaContainer.appendChild(tabla);
                    /* ------------------------------------------------------------------------------- */

                })
                .catch(function (error) {
                    // Manejo de errores si la solicitud no tiene éxito
                    console.error('Error al obtener el post:', error);
                });


        }



        function actualizarEstado(idPedido, idEstado) {
            const apiUrl = `http://localhost:3000/api/pedido`;


            switch (idEstado) {
                case 1:
                    idEstado = 2;
                    break;
                case 2:
                    idEstado = 3
                    break;

                case 3:
                    alert("No se puede cambiar estado")
                    return
                    break;

                default:
                    break;
            }
     
            // Datos del nuevo post que queremos crear
            const postData = {
                idEstado: idEstado,
                idPedido: idPedido
            };

            axios.put(apiUrl, postData)
                .then(function (response) {
                    // La respuesta de la API se encuentra en 'response.data'
                    console.log(response);

                    alert("Estado Actualizado")
                    cargarPedidos();

                })
                .catch(function (error) {
                    // Manejo de errores si la solicitud no tiene éxito
                    console.error('Error al crear el nuevo post:', error);
                });

        }



    </script>

</body>

</html>